{% extends "layout.html" %}
{% block content %}
<script>
      document.addEventListener("DOMNodeInserted", function () {
        var b = document.body;

        // Additional padding/border to account for in calculations
        var offset = b.scrollHeight - b.offsetHeight;

        // Amount we have scrolled down
        var scrollPos = b.scrollTop + offset;

        // Amount of scroll available, minus the visible portion (because scrollPos
        // is the *top* of the visible portion)
        var scrollBottom = (b.scrollHeight - (b.clientHeight + offset));

        //console.log("offset: " + offset);
        //console.log("scrollPos:" + scrollPos);
        //console.log("scrollBottom:" + scrollBottom);

        // If we are at the bottom, go to the bottom again.
        if (scrollPos >= scrollBottom) {
          window.scrollTo(0, document.body.scrollHeight);
        }

      }, false);
    </script>

  <nav class="navbar navbar-expand-md navbar-dark bg-steel fixed-bottom">
    <div class="container">
      <div class="navbar-item is-expanded">

        <input id="chat_text" class="input" type="text" style="width:1000px;">
        <button id="chat_btn" class="btn btn-success">Post</button>



      </div>
    </div>

  </nav>

  <div id="content" class="container" style="overflow-y:auto; margin-bottom: 200px;">

    {% for message in messages %}
    <article class="media">
      <div class="media-content">
        <div class="content">
          <p>
            <img class="rounded-circle article-img" src="{{ url_for('static', filename='profile_pics/' + message.image_file) }}">
            <strong >{{ message.username }}</strong>
            {{message.date_posted.strftime('%B %d %Y - %H:%M:%S')}}
            <br> <span style="margin-left:100px;">
              {{ message.message }}
            </span>
          </p>
        </div>
      </div>
    </article>
    {% endfor %}
  </div>





  <script src="https://js.pusher.com/4.1/pusher.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
  crossorigin="anonymous"></script>

  <script>
    $(function() {
      let username = "{{ current_user.username }}";

      $('#chat_btn').on('click', function() {
        let message = $('#chat_text').val();
        if (message != ''){
        $.post('/message', {'username' : username, 'message' : message}, function() {
          $('#chat_text').val('');
        });
      }
      });
      var input = document.getElementById("chat_text");
      input.addEventListener("keyup", function(event) {
          event.preventDefault();
          if (event.keyCode === 13) {
              document.getElementById("chat_btn").click();
          }
      });
          // Enable pusher logging - don't include this in production
      Pusher.logToConsole = true;
      var pusher = new Pusher('1d2e73839f1798803872', {
        cluster: 'us2',
        encrypted: true
      });
      var channel = pusher.subscribe('chat-channel');
      channel.bind('new-message', function(data) {
          let name = data.username;
          let message = data.message;
          let time = data.time;
          let image = data.image;
          let message_template = `<article class="media">
                                  <div class="media-content">
                                    <div class="content">
                                      <p>
                                        <img class="rounded-circle article-img" src="../static/profile_pics/${image}">
                                        <strong>${name}</strong>
                                        ${time}
                                        <br> <span style="margin-left:100px;">
                                          ${message}
                                        </span>
                                      </p>
                                    </div>
                                  </div>
                                </article>`;

          $('#content').append(message_template);
        });


    });
  </script>


{% endblock content %}
